<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>登录 - {{ .Name }}</title>
<link rel="icon" type="image/jpeg" href="/favicon.jpg">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
<style>
body {
    padding: 0px;
    margin: 1em;
}

@media screen and (min-width: 500px) {
	#wrapper {
		max-width: 300px;
	}
}

input, button {
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 0.8em;
	border: 1px solid #ddd;
	border-radius: 4px;
	padding-left: 7px;
	padding-right: 7px;
}
input[type=text],input[type=password] {
	line-height: 3em;
}
button, input[type=submit] {
	line-height: 3.5em;
	background-color: #eee;
	color: inherit;
}
button:hover, input[type=submit]:hover {
	background-color: #e8e8e8;
}
</style>
<script>
window.onerror = function myErrorHandler(errorMsg, url, lineNumber) {
    console.warn("Error occurred: " + errorMsg + ' at line: ' + lineNumber);//or any message
    return false;
};
</script>
<script src="script.js"></script>
</head>
<body>
<div id="wrapper">
<h1>{{ .Name }}</h1>
<button onclick="location.href='/'">返回首页</button>
<h2>通行密钥登录</h2>
<div>
	<button onclick="webauthn()">登录</button>
	<script>
		async function webauthn() {
			let wa = new WebAuthn();
			try {
				await wa.login();
				alert('登录成功。');
				location.href = 'profile';
			} catch(e) {
				if (e instanceof DOMException && e.name == "AbortError") {
					console.log('已取消操作。');
					return;
				}
				alert(e);
			}
		}
	</script>
</div>
{{ if .HasSocialLogins }}
<h2>社交帐号登录</h2>
<div>
	{{ if .GoogleClientID }}
	<div>
	<button id="google-signin-button">
		Google
	</button>
	<button style="display: none;" id="google-signin-button-hidden">hidden sign-in button</button>
	<script src="https://apis.google.com/js/api:client.js"></script>
	<script>
		setTimeout(function() {
			let btn = document.getElementById('google-signin-button');
			let btnHidden = document.getElementById('google-signin-button-hidden');
			btn.addEventListener('click', function(e) {
				e.stopPropagation();
				e.preventDefault();
				btnHidden.click();
			});

			let googleUser = {};
			gapi.load('auth2', function(){
				// Retrieve the singleton for the GoogleAuth library and set up the client.
				auth2 = gapi.auth2.init({
					client_id: '{{.GoogleClientID}}.apps.googleusercontent.com',
					cookiepolicy: 'single_host_origin',
				});
				auth2.attachClickHandler(btnHidden, {},
					async function(googleUser) {
						var id_token = googleUser.getAuthResponse().id_token;
						console.log("ID Token: " + id_token);
						let resp = await fetch(location.pathname + "/google", {
							method: 'POST',
							credentials: 'include',
							body: JSON.stringify({
								token: id_token,
							}),
						});
						if (resp.status == 200) {
							var auth2 = gapi.auth2.getAuthInstance();
							auth2.disconnect().then(function () {
								location.href = 'profile';
							});
						} else {
							alert('Error: ' + await resp.text());
						}
					},
					function(error) {
						alert(JSON.stringify(error, undefined, 2));
					}
				);
			});
		}, 0);
	</script>
	</div>
	{{end}}
	{{ if .GitHubClientID }}
	<div>
	<button id="github-signin-button">
		GitHub
	</button>
	<script>
		var github = document.getElementById('github-signin-button');
		github.addEventListener('click', function() {
			location.href = "https://github.com/login/oauth/authorize?client_id={{ .GitHubClientID }}";
		});
	</script>
	</div>
	{{ end }}
</div>
{{ end }}
<h2>用户名登录</h2>
<form method="post" id="login-form">
	<div id="input-wrapper">
		<div class=left>
			<div>
				<input type="text" name="user" placeholder="用户名" required />
				<input type="password" name="passwd" placeholder="密码" required />
			</div>	
			<div class="submit" style="text-align: right;">
				<input type="submit" value="登录" />
			</div>
			<script>
				(function(){
					let form = document.getElementById('login-form');
					form.addEventListener('submit', async function(ev){
						ev.stopPropagation();
						ev.preventDefault();

						let resp = await fetch(location.pathname + '/basic', {
							method: 'POST',
							credentials: "include",
							body: JSON.stringify({
								username: form.elements['user'].value,
								password: form.elements['passwd'].value,
							}),
						});
						if (resp.status == 200) {
							location.href = 'profile';
						} else {
							alert('Error: ' + await resp.text());
						}

						return true;
					});
				})();
			</script>
		</div>
	</div>
</form>
</div>
</body>
</html>
