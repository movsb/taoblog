<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>登录 - {{ .Name }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
<link rel="stylesheet" type="text/css" href="/style.css" />
<link rel="stylesheet" type="text/css" href="https://npm.elemecdn.com/lxgw-wenkai-webfont/style.css" />
<script>
window.onerror = function myErrorHandler(errorMsg, url, lineNumber) {
    console.warn("Error occurred: " + errorMsg + ' at line: ' + lineNumber);//or any message
    return false;
};
</script>
<script src="script.js"></script>
<script>
function redirect(to) {
	if (!to) {
		let args = new URLSearchParams(location.search);
		if (args.has('u')) {
			to = args.get('u');
		}
	}
	if (!to) {
		to = 'profile';
	}
	window.location = to;
}
</script>
</head>
<body class="admin">
<div id="wrapper">
<h1>{{ .Name }}</h1>
<button onclick="location.href='/'">返回首页</button>
<h2>通行密钥登录</h2>
<div>
	<button onclick="webauthn()">登录</button>
	<script>
		async function webauthn() {
			let wa = new WebAuthn();
			try {
				await wa.login();
				alert('登录成功。');
				redirect();
			} catch(e) {
				if (e instanceof DOMException && e.name == "AbortError") {
					console.log('已取消操作。');
					return;
				}
				alert(e);
			}
		}
	</script>
</div>
{{ if .HasSocialLogins }}
<h2>社交帐号登录</h2>
<div>
	{{ if .GoogleClientID }}
	<div>
	<button id="google-signin-button">
		Google
	</button>
	<button style="display: none;" id="google-signin-button-hidden">hidden sign-in button</button>
	<script src="https://apis.google.com/js/api:client.js"></script>
	<script>
		setTimeout(function() {
			let btn = document.getElementById('google-signin-button');
			let btnHidden = document.getElementById('google-signin-button-hidden');
			btn.addEventListener('click', function(e) {
				e.stopPropagation();
				e.preventDefault();
				btnHidden.click();
			});

			let googleUser = {};
			gapi.load('auth2', function(){
				// Retrieve the singleton for the GoogleAuth library and set up the client.
				auth2 = gapi.auth2.init({
					client_id: '{{.GoogleClientID}}.apps.googleusercontent.com',
					cookiepolicy: 'single_host_origin',
				});
				auth2.attachClickHandler(btnHidden, {},
					async function(googleUser) {
						var id_token = googleUser.getAuthResponse().id_token;
						console.log("ID Token: " + id_token);
						let resp = await fetch(location.pathname + "/google", {
							method: 'POST',
							credentials: 'include',
							body: JSON.stringify({
								token: id_token,
							}),
						});
						if (resp.status == 200) {
							var auth2 = gapi.auth2.getAuthInstance();
							auth2.disconnect().then(function () {
								redirect();
							});
						} else {
							alert('Error: ' + await resp.text());
						}
					},
					function(error) {
						alert(JSON.stringify(error, undefined, 2));
					}
				);
			});
		}, 0);
	</script>
	</div>
	{{end}}
	{{ if .GitHubClientID }}
	<div>
	<button id="github-signin-button">
		GitHub
	</button>
	<script>
		var github = document.getElementById('github-signin-button');
		github.addEventListener('click', function() {
			location.href = "https://github.com/login/oauth/authorize?client_id={{ .GitHubClientID }}";
		});
	</script>
	</div>
	{{ end }}
</div>
{{ end }}
<h2>用户名登录</h2>
<form method="post" id="login-form">
	<div>
		<input type="text" name="user" placeholder="用户名" required />
		<br />
		<input type="password" name="passwd" placeholder="密码" required />
	</div>	
	<div>
		<input type="submit" value="登录" />
	</div>
	<script>
		(function(){
			let form = document.getElementById('login-form');
			form.addEventListener('submit', async function(ev){
				ev.stopPropagation();
				ev.preventDefault();

				let resp = await fetch(location.pathname + '/basic', {
					method: 'POST',
					credentials: "include",
					body: JSON.stringify({
						username: form.elements['user'].value,
						password: form.elements['passwd'].value,
					}),
				});
				if (resp.status == 200) {
					redirect();
				} else {
					alert('Error: ' + await resp.text());
				}

				return true;
			});
		})();
	</script>
</form>
</div>
</body>
</html>
