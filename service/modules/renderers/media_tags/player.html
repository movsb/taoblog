<div class="audio-player" id="{{.Random}}">
	<div class="left">
		{{ with .PictureAsImage }}
			{{ . }} 
		{{ else }}
		<!-- https://www.svgrepo.com/svg/452186/disc -->
		<svg width="800px" height="800px" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
			<path d="M16 32C24.8366 32 32 24.8366 32 16C32 7.16344 24.8366 0 16 0C7.16344 0 0 7.16344 0 16C0 24.8366 7.16344 32 16 32Z" fill="#473333"/>
			<path d="M16.0003 23.2727C20.0169 23.2727 23.273 20.0166 23.273 16C23.273 11.9834 20.0169 8.72729 16.0003 8.72729C11.9836 8.72729 8.72754 11.9834 8.72754 16C8.72754 20.0166 11.9836 23.2727 16.0003 23.2727Z" fill="#EE4F07"/>
			<path d="M15.9999 18.9091C17.6066 18.9091 18.909 17.6067 18.909 16C18.909 14.3934 17.6066 13.0909 15.9999 13.0909C14.3933 13.0909 13.0908 14.3934 13.0908 16C13.0908 17.6067 14.3933 18.9091 15.9999 18.9091Z" fill="white"/>
		</svg>
		{{ end }}
	</div>
	<div class="right {{with .Lyrics}}has-lyrics{{end}}">
		<div class="info">
			{{with .Title}}<p><b>标题：</b>{{.}}</p>{{end}}
			{{with .Album}}<p><b>专辑：</b>{{.}}</p>{{end}}
			{{with .Artist}}<p><b>作者：</b>{{.}}</p>{{end}}
			{{with .Composer}}<p><b>作曲：</b>{{.}}</p>{{end}}
			{{with .Year}}<p><b>年代：</b>{{.}}</p>{{end}}
			<!-- {{with .Genre}}<p><b>流派：</b>{{.}}</p>{{end}} -->
			<!-- {{with .Lyrics}}<p class="lyrics">{{.}}</p>{{end}} -->
		</div>
		<audio src="{{.Source}}">
			<img id="img-{{.Random}}" style="display: none;" src="not-found://" onerror=" let script = document.querySelector('#script-{{.Random}}'); let parent = script.parentElement; let s = document.createElement('script'); s.innerHTML = script.innerHTML; script.remove(); parent.appendChild(s); handleAudio({{.Random}});" />
		</audio>
		<div class="controls">
			<svg class="play no-zoom" title="播放" fill="var(--color-fg)" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="64px" height="64px" viewBox="-16.39 -16.39 196.64 196.64" xml:space="preserve" stroke="#000000" stroke-width="0.00163861" transform="matrix(1, 0, 0, 1, 0, 0)rotate(0)"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="1.3108879999999998"></g><g> <g> <path d="M34.857,3.613C20.084-4.861,8.107,2.081,8.107,19.106v125.637c0,17.042,11.977,23.975,26.75,15.509L144.67,97.275 c14.778-8.477,14.778-22.211,0-30.686L34.857,3.613z"></path> </g> </g></svg>
			<svg class="pause no-zoom" title="暂停" fill="var(--color-fg)" width="64px" height="64px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g><path fill-rule="evenodd" clip-rule="evenodd" d="M5.163 3.819C5 4.139 5 4.559 5 5.4v13.2c0 .84 0 1.26.163 1.581a1.5 1.5 0 0 0 .656.655c.32.164.74.164 1.581.164h.2c.84 0 1.26 0 1.581-.163a1.5 1.5 0 0 0 .656-.656c.163-.32.163-.74.163-1.581V5.4c0-.84 0-1.26-.163-1.581a1.5 1.5 0 0 0-.656-.656C8.861 3 8.441 3 7.6 3h-.2c-.84 0-1.26 0-1.581.163a1.5 1.5 0 0 0-.656.656zm9 0C14 4.139 14 4.559 14 5.4v13.2c0 .84 0 1.26.164 1.581a1.5 1.5 0 0 0 .655.655c.32.164.74.164 1.581.164h.2c.84 0 1.26 0 1.581-.163a1.5 1.5 0 0 0 .655-.656c.164-.32.164-.74.164-1.581V5.4c0-.84 0-1.26-.163-1.581a1.5 1.5 0 0 0-.656-.656C17.861 3 17.441 3 16.6 3h-.2c-.84 0-1.26 0-1.581.163a1.5 1.5 0 0 0-.655.656z" ></path></g></svg>
			<input class="progress" type=range min=0 max=100 value=0 autocomplete="off"/>
			<span class="time">00:00</span>
		</div>
	</div>
	<script id="script-{{.Random}}">
		function handleAudio(r) {
			let player = document.querySelector(`#${r}`);
			let audio = player.querySelector(':scope audio');
			let time = player.querySelector('.time');
			audio.addEventListener('play', e => {
				player.classList.add('playing');
			});
			audio.addEventListener('pause', e => {
				player.classList.remove('playing');
			});
			let displaySeconds = t => {
				let seconds = Math.floor(t+.5);
				let minutes = Math.floor(seconds / 60);
				seconds = Math.floor(seconds % 60);
				return `${minutes<10?'0'+minutes:minutes}:${seconds<10?'0'+seconds:seconds}`;
			};
			audio.addEventListener('loadedmetadata', e => {
				console.log(audio.duration);
				time.setAttribute('title', `总时长：${displaySeconds(audio.duration)}`);
			});
			let progress = player.querySelector('.progress');
			let capturing = false;
			progress.addEventListener('mousedown', e=>{
				capturing = true;
			}, true);
			progress.addEventListener('mouseup', e=>{
				capturing = false;
				audio.play();
			}, true);
			let progressDebouncing = undefined;
			progress.addEventListener('input', e=> {
				let tracking = +progress.value / +progress.max * audio.duration;
				time.innerText = displaySeconds(tracking);
				let set = () => audio.currentTime = tracking;
				if (audio.paused) { set(); return; }
				clearTimeout(progressDebouncing);
				progressDebouncing = setTimeout(set, 250);
			});
			audio.addEventListener('timeupdate', e => {
				if (!capturing) {
					progress.value = audio.currentTime / audio.duration * 100;
					time.innerText = displaySeconds(audio.currentTime);
				}
			});
			let play =player.querySelector('.play');
			let pause = player.querySelector('.pause');
			play.addEventListener('click', e=>{ audio.play(); })
			pause.addEventListener('click', e=>{ audio.pause(); })
		}
	</script>
</div>
